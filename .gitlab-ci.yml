stages:
  - install
  - build
  - publish-first
  - publish

variables:
  PARENT_PIPELINE_ID: $CI_PIPELINE_ID
  LOG_LEVEL: info

.publish-first-docker:
  stage: publish-first
  before_script:
    - cd $DOCKER_CONTEXT
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_BUILD_TOKEN $CI_REGISTRY
    - docker build --pull -t $CI_REGISTRY_IMAGE/$CONTAINER_IMAGE .
    - docker push $CI_REGISTRY_IMAGE/$CONTAINER_IMAGE
  tags:
    - docker

.publish-first-gl-artifacts:
  stage: publish-first
  before_script:
    - cd ./gl-artifacts
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_BUILD_TOKEN $CI_REGISTRY
    - docker build --pull -t $CI_REGISTRY_IMAGE/$CONTAINER_IMAGE .
    - docker push $CI_REGISTRY_IMAGE/$CONTAINER_IMAGE
  tags:
    - docker

.publish-docker-to-private:
  stage: publish
  trigger:
    include:
      - project: devops/pipes
        file: /templates/docker-build-with-artifacts.gitlab-ci.yml
        ref: main
    strategy: depend

.publish-docker-to-public:
  stage: publish
  trigger:
    include:
      - project: devops/pipes
        file: /templates/docker-build-with-artifacts-dockerhub.gitlab-ci.yml
        ref: main
    strategy: depend

include:
  project: devops/pipes
  file: /templates/go-install.gitlab-ci.yml

build:
  stage: build
  image: golang:alpine
  before_script:
    - cd ${APP_FOLDER}
  script:
    - apk add --no-cache --no-progress make git
    - make -j4 build
    - ./dist/${APP_BINARY} --help
  artifacts:
    paths:
      - ${APP_FOLDER}/dist/
  parallel:
    matrix:
      - APP_FOLDER: ./docker
        APP_BINARY: gitlab-pipes-docker

      - APP_FOLDER: ./node
        APP_BINARY: gitlab-pipes-node

      - APP_FOLDER: ./node-typedoc
        APP_BINARY: node-typedoc

      - APP_FOLDER: ./gl-artifacts
        APP_BINARY: gitlab-pipes-gl-artifacts

      - APP_FOLDER: ./markdown-toc
        APP_BINARY: markdown-toc

      - APP_FOLDER: ./update-docker-hub-readme
        APP_BINARY: update-docker-hub-readme

      - APP_FOLDER: ./semantic-release
        APP_BINARY: semantic-release
  tags:
    - docker

# to stop depending on itself

publish-first-docker:
  extends: .publish-first-docker
  variables:
    DOCKER_CONTEXT: ./docker
    APP_BINARY: gitlab-pipes-docker
    CONTAINER_IMAGE: gitlab-pipes-docker:latest
  only:
    changes:
      - "docker/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main

publish-first-gl-artifacts:
  extends: .publish-first-docker
  variables:
    DOCKER_CONTEXT: ./gl-artifacts
    APP_BINARY: gl-artifacts
    CONTAINER_IMAGE: gitlab-pipes-gl-artifacts:latest
  only:
    changes:
      - "gl-artifacts/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main

# private images

publish-docker:
  extends: .publish-docker-to-private
  variables:
    DOCKERFILE_CONTEXT: ./docker
    DOCKER_IMAGE_NAME: gitlab-pipes-docker
    IMAGE_TAGS: latest
    PARENT_DOWNLOAD_ARTIFACTS: "build: [./docker, gitlab-pipes-docker]"
  only:
    changes:
      - "docker/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main
      - tags

publish-node:
  extends: .publish-docker-to-private
  variables:
    DOCKERFILE_CONTEXT: ./node
    DOCKER_IMAGE_NAME: gitlab-pipes-node
    PARENT_DOWNLOAD_ARTIFACTS: "build: [./node, gitlab-pipes-node]"
  parallel:
    matrix:
      - IMAGE_TAGS: ${NODE_VERSION}
        BUILD_ARGS: NODE_VERSION=${NODE_VERSION}
        NODE_VERSION:
          - 16
          - 16-alpine
  only:
    changes:
      - "node/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main

publish-gl-artifacts:
  extends: .publish-docker-to-private
  variables:
    DOCKERFILE_CONTEXT: ./gl-artifacts
    DOCKER_IMAGE_NAME: gitlab-pipes-gl-artifacts
    IMAGE_TAGS: latest
    PARENT_DOWNLOAD_ARTIFACTS: "build: [./gl-artifacts, gitlab-pipes-gl-artifacts]"
  only:
    changes:
      - "gl-artifacts/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main
      - tags

# public images

publish-markdown-toc:
  extends: .publish-docker-to-public
  variables:
    DOCKERFILE_CONTEXT: ./markdown-toc
    IMAGE_NAME: cenk1cenk2/pipe-markdown-toc
    IMAGE_TAGS: latest
    PARENT_DOWNLOAD_ARTIFACTS: "build: [./markdown-toc, markdown-toc]"
  only:
    changes:
      - "markdown-toc/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main
      - tags

publish-node-typedoc:
  extends: .publish-docker-to-public
  variables:
    DOCKERFILE_CONTEXT: ./node-typedoc
    IMAGE_NAME: cenk1cenk2/pipe-node-typedoc
    IMAGE_TAGS: latest
    PARENT_DOWNLOAD_ARTIFACTS: "build: [./node-typedoc, node-typedoc]"
  only:
    changes:
      - "node-typedoc/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main
      - tags

publish-update-docker-hub-readme:
  extends: .publish-docker-to-public
  variables:
    DOCKERFILE_CONTEXT: ./update-docker-hub-readme
    IMAGE_NAME: cenk1cenk2/pipe-update-docker-hub-readme
    IMAGE_TAGS: latest
    PARENT_DOWNLOAD_ARTIFACTS: "build: [./update-docker-hub-readme, update-docker-hub-readme]"
  only:
    changes:
      - "update-docker-hub-readme/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main
      - tags

publish-semantic-release:
  extends: .publish-docker-to-public
  variables:
    DOCKERFILE_CONTEXT: ./semantic-release
    IMAGE_NAME: cenk1cenk2/pipe-semantic-release
    IMAGE_TAGS: latest
    PARENT_DOWNLOAD_ARTIFACTS: "build: [./semantic-release, semantic-release]"
  only:
    changes:
      - "semantic-release/**/*"
      - "node/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main
      - tags
