---
stages:
  - bootstrap
  - install
  - test
  - pipes
  - post

bootstrap:
  stage: bootstrap
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.bootstrap.yml
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.bootstrap.yml
          - go/**/*
          - buildah/**/*
    - if: $CI_COMMIT_TAG

install:
  stage: install
  image: cenk1cenk2/pipe-go:bootstrap
  script:
    - pipe install
  artifacts:
    paths:
      - vendor/
  cache:
    - key: $CI_JOB_NAME_SLUG
      paths:
        - vendor/
        - .go/
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      # changes:
      #   paths:
      #     - .gitlab-ci.yml
      #     - go.mod
      #     - go.sum
      #     - "**/*.go"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      interruptible: true
      # changes:
      #   paths:
      #     - .gitlab-ci.yml
      #     - go.mod
      #     - go.sum
      #     - "**/*.go"
      #   compare_to: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - if: $CI_COMMIT_TAG
  tags:
    - amd64
    - docker

lint:
  stage: test
  image: cenk1cenk2/pipe-go:bootstrap
  cache:
    - key: $CI_JOB_NAME_SLUG
      paths:
        - .go/
  # needs:
  #   - pipeline: $CI_PARENT_PIPELINE_ID
  #     job: install
  #     artifacts: true
  script:
    - pipe lint
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      # changes:
      #   paths:
      #     - .gitlab-ci.yml
      #     - go.mod
      #     - go.sum
      #     - "**/*.go"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      interruptible: true
      # changes:
      #   paths:
      #     - .gitlab-ci.yml
      #     - go.mod
      #     - go.sum
      #     - "**/*.go"
      #   compare_to: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - if: $CI_COMMIT_TAG
  tags:
    - amd64
    - docker

pipe-template:
  stage: pipes
  variables:
    CI_PARENT_PIPELINE_ID: $CI_PIPELINE_ID
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          cwd: ./_template
          container-image-name: cenk1cenk2/pipe-template
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_TAGS: |-
                latest
          container-rules:
            - when: never
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - _template/**/*
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      interruptible: true
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - _template/**/*
        compare_to: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - if: $CI_COMMIT_TAG

pipe-buildah:
  stage: pipes
  variables:
    CI_PARENT_PIPELINE_ID: $CI_PIPELINE_ID
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          cwd: ./buildah
          container-image-name: cenk1cenk2/pipe-buildah
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_TAGS: |-
                latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - buildah/**/*
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      interruptible: true
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - buildah/**/*
        compare_to: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - if: $CI_COMMIT_TAG

pipe-docker:
  stage: pipes
  variables:
    CI_PARENT_PIPELINE_ID: $CI_PIPELINE_ID
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          cwd: ./docker
          container-image-name: cenk1cenk2/pipe-docker
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_TAGS: |-
                latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - docker/**/*
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      interruptible: true
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - docker/**/*
        compare_to: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - if: $CI_COMMIT_TAG

pipe-go:
  stage: pipes
  variables:
    CI_PARENT_PIPELINE_ID: $CI_PIPELINE_ID
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          cwd: ./go
          container-image-name: cenk1cenk2/pipe-go
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_BUILD_ARGS: |-
                GO_VERSION: '{{ env "GO_VERSION" }}'
              CONTAINER_IMAGE_TAGS: |-
                {{ env "GO_VERSION" }}
              GO_VERSION:
                - 1.25-alpine
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - go/**/*
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      interruptible: true
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - go/**/*
        compare_to: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - if: $CI_COMMIT_TAG

pipe-helm:
  stage: pipes
  variables:
    CI_PARENT_PIPELINE_ID: $CI_PIPELINE_ID
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          cwd: ./helm
          container-image-name: cenk1cenk2/pipe-helm
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_TAGS: |-
                latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - helm/**/*
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      interruptible: true
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - helm/**/*
        compare_to: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - if: $CI_COMMIT_TAG

pipe-markdown-toc:
  stage: pipes
  variables:
    CI_PARENT_PIPELINE_ID: $CI_PIPELINE_ID
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          cwd: ./markdown-toc
          container-image-name: cenk1cenk2/pipe-markdown-toc
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_TAGS: |-
                latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - markdown-toc/**/*
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      interruptible: true
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - markdown-toc/**/*
        compare_to: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - if: $CI_COMMIT_TAG

pipe-node:
  stage: pipes
  variables:
    CI_PARENT_PIPELINE_ID: $CI_PIPELINE_ID
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          cwd: ./node
          container-image-name: cenk1cenk2/pipe-node
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_BUILD_ARGS: |-
                NODE_VERSION: '{{ env "NODE_VERSION" }}'
              CONTAINER_IMAGE_TAGS: |-
                {{ env "NODE_VERSION" }}
              NODE_VERSION:
                - 20
                - 20-alpine
                - 22
                - 22-alpine
                - 24
                - 24-alpine
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - node/**/*
          - select-env/**/*
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      interruptible: true
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - node/**/*
          - select-env/**/*
        compare_to: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - if: $CI_COMMIT_TAG

pipe-pulumi:
  stage: pipes
  variables:
    CI_PARENT_PIPELINE_ID: $CI_PIPELINE_ID
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          cwd: ./pulumi
          container-image-name: cenk1cenk2/pipe-pulumi
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile-node
              CONTAINER_IMAGE_BUILD_ARGS: |-
                PULUMI_VERSION: '{{ env "PULUMI_VERSION" }}'
                NODE_VERSION: '{{ env "NODE_VERSION" }}'
              CONTAINER_IMAGE_TAGS: |-
                {{ env "PULUMI_VERSION" }}-node
              PULUMI_VERSION:
                - latest
              NODE_VERSION: 24-alpine
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - pulumi/**/*
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      interruptible: true
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - pulumi/**/*
        compare_to: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - if: $CI_COMMIT_TAG

pipe-select-env:
  stage: pipes
  variables:
    CI_PARENT_PIPELINE_ID: $CI_PIPELINE_ID
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          cwd: ./select-env
          container-image-name: cenk1cenk2/pipe-select-env
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_TAGS: |-
                latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - select-env/**/*
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      interruptible: true
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - select-env/**/*
        compare_to: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - if: $CI_COMMIT_TAG

pipe-semantic-release:
  stage: pipes
  variables:
    CI_PARENT_PIPELINE_ID: $CI_PIPELINE_ID
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          cwd: ./semantic-release
          container-image-name: cenk1cenk2/pipe-semantic-release
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_BUILD_ARGS: |-
                NODE_VERSION: 22-alpine
              CONTAINER_IMAGE_TAGS: |-
                latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - semantic-release/**/*
          - select-env/**/*
          - node/**/*
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      interruptible: true
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - semantic-release/**
          - select-env/**/*
          - node/**/*
        compare_to: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - if: $CI_COMMIT_TAG

pipe-terraform:
  stage: pipes
  variables:
    CI_PARENT_PIPELINE_ID: $CI_PIPELINE_ID
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          cwd: ./terraform
          container-image-name: cenk1cenk2/pipe-terraform
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_TAGS: |-
                latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - terraform/**/*
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      interruptible: true
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - terraform/**/*
        compare_to: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - if: $CI_COMMIT_TAG

pipe-update-docker-hub-readme:
  stage: pipes
  variables:
    CI_PARENT_PIPELINE_ID: $CI_PIPELINE_ID
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          cwd: ./update-docker-hub-readme
          container-image-name: cenk1cenk2/pipe-update-docker-hub-readme
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_TAGS: |-
                latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - update-docker-hub-readme/**/*
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      interruptible: true
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - update-docker-hub-readme/**/*
        compare_to: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - if: $CI_COMMIT_TAG

update-docker-hub-readme:
  stage: post
  image: cenk1cenk2/pipe-update-docker-hub-readme:latest
  dependencies: []
  variables:
    DOCKER_USERNAME: $DOCKERHUB_USERNAME
    DOCKER_PASSWORD: $DOCKERHUB_API_PASSWORD
    README_MATRIX: |
      [
        {
          "repository": "cenk1cenk2/pipe-buildah",
          "file": "./buildah/README.md",
          "description": "Builds and publishes a container image with given conditions."
        },
        {
          "repository": "cenk1cenk2/pipe-docker",
          "file": "./docker/README.md",
          "description": "Builds and publishes a Docker image with given conditions."
        },
        {
          "repository": "cenk1cenk2/pipe-node",
          "file": "./node/README.md",
          "description": "Node.JS operations for pipelines."
        },
        {
          "repository": "cenk1cenk2/pipe-pulumi",
          "file": "./pulumi/README.md",
          "description": "Pulumi operations for pipelines."
        },
        {
          "repository": "cenk1cenk2/pipe-go",
          "file": "./go/README.md",
          "description": "Golang operations for pipelines."
        },
        {
          "repository": "cenk1cenk2/pipe-markdown-toc",
          "file": "./markdown-toc/README.md",
          "description": "Generates TOC for markdown files."
        },
        {
          "repository": "cenk1cenk2/pipe-select-env",
          "file": "./select-env/README.md",
          "description": "Selects an environment given on the conditions."
        },
        {
          "repository": "cenk1cenk2/pipe-semantic-release",
          "file": "./semantic-release/README.md",
          "description": "semantic-release embedded inside a container for CI jobs."
        },
        {
          "repository": "cenk1cenk2/pipe-terraform",
          "file": "./terraform/README.md",
          "description": "Terraform helper pipe."
        },
        {
          "repository": "cenk1cenk2/pipe-update-docker-hub-readme",
          "file": "./update-docker-hub-readme/README.md",
          "description": "Updates the README on DockerHub for given repository."
        }
      ]
  script:
    - pipe
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - "**/README.md"
    - if: $CI_COMMIT_TAG
