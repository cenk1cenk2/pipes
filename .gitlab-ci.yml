---
stages:
  - install
  - build
  - publish-first
  - publish
  - post

variables:
  PARENT_PIPELINE_ID: $CI_PIPELINE_ID
  LOG_LEVEL: trace

.publish-first:
  stage: publish-first
  before_script:
    - cd $DOCKER_CONTEXT
  variables:
    DOCKER_BUILDKIT: "1"
  script:
    - docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_PASSWORD
    - docker build --pull -t $DOCKER_IMAGE_NAME .
    - docker push $DOCKER_IMAGE_NAME
  tags:
    - docker

.publish-docker-to-private:
  stage: publish
  trigger:
    include:
      - project: devops/pipes
        file: /templates/docker-build-with-artifacts.gitlab-ci.yml
    strategy: depend

.publish-docker-to-public:
  stage: publish
  trigger:
    include:
      - project: devops/pipes
        file: /templates/docker-build-with-artifacts-dockerhub.gitlab-ci.yml
    strategy: depend

.docker-hub-readme:
  stage: post
  trigger:
    include:
      - project: devops/pipes
        file: /templates/update-docker-hub-readme.gitlab-ci.yml
    strategy: depend

include:
  - project: devops/pipes
    file: /templates/go-install.gitlab-ci.yml
  - project: devops/pipes
    file: /templates/go-build.gitlab-ci.yml
  - project: devops/pipes
    file: /templates/go-lint.gitlab-ci.yml

build:
  variables:
    GO_BUILD_COMMAND: task $PIPE:build
  artifacts:
    paths:
      - "./*/dist/"
  parallel:
    matrix:
      - PIPE: template
      - PIPE: docker
      - PIPE: gh-release-tracker
      - PIPE: node
      - PIPE: gl-artifacts
      - PIPE: markdown-toc
      - PIPE: update-docker-hub-readme
      - PIPE: semantic-release
      - PIPE: select-env
      - PIPE: s3-upload

# to stop depending on itself

publish-first-docker:
  extends: .publish-first
  variables:
    DOCKER_CONTEXT: ./docker
    DOCKER_IMAGE_NAME: cenk1cenk2/pipe-docker:latest
  only:
    changes:
      - "common/**/*"
      - "docker/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main
      - tags

publish-first-gl-artifacts:
  extends: .publish-first
  variables:
    DOCKER_CONTEXT: ./gl-artifacts
    DOCKER_IMAGE_NAME: cenk1cenk2/pipe-gl-artifacts:latest
  only:
    changes:
      - "common/**/*"
      - "gl-artifacts/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main
      - tags

# private images

# public images

publish-docker:
  extends: .publish-docker-to-public
  variables:
    DOCKERFILE_CONTEXT: ./docker
    DOCKER_IMAGE_NAME: cenk1cenk2/pipe-docker
    DOCKER_IMAGE_TAGS: latest
    PARENT_DOWNLOAD_ARTIFACTS: "build: [docker]"
  only:
    changes:
      - "common/**/*"
      - "docker/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main
      - tags

publish-gl-artifacts:
  extends: .publish-docker-to-public
  variables:
    DOCKERFILE_CONTEXT: ./gl-artifacts
    DOCKER_IMAGE_NAME: cenk1cenk2/pipe-gl-artifacts
    DOCKER_IMAGE_TAGS: latest
    PARENT_DOWNLOAD_ARTIFACTS: "build: [gl-artifacts]"
  only:
    changes:
      - "common/**/*"
      - "gl-artifacts/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main
      - tags

publish-node:
  extends: .publish-docker-to-public
  variables:
    DOCKERFILE_CONTEXT: ./node
    DOCKER_IMAGE_NAME: cenk1cenk2/pipe-node
    PARENT_DOWNLOAD_ARTIFACTS: "build: [node]"
  parallel:
    matrix:
      - DOCKER_IMAGE_TAGS: ${NODE_VERSION}
        DOCKER_BUILD_ARGS: NODE_VERSION=${NODE_VERSION}
        NODE_VERSION:
          - 16
          - 16-alpine
          - 18
          - 18-alpine
  only:
    changes:
      - "common/**/*"
      - "select-env/**/*"
      - "node/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main
      - tags

publish-gh-release-tracker:
  extends: .publish-docker-to-public
  variables:
    DOCKERFILE_CONTEXT: ./gh-release-tracker
    DOCKER_IMAGE_NAME: cenk1cenk2/pipe-gh-release-tracker
    DOCKER_IMAGE_TAGS: latest
    PARENT_DOWNLOAD_ARTIFACTS: "build: [gh-release-tracker]"
  only:
    changes:
      - "common/**/*"
      - "gh-release-tracker/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main
      - tags

publish-markdown-toc:
  extends: .publish-docker-to-public
  variables:
    DOCKERFILE_CONTEXT: ./markdown-toc
    DOCKER_IMAGE_NAME: cenk1cenk2/pipe-markdown-toc
    DOCKER_IMAGE_TAGS: latest
    PARENT_DOWNLOAD_ARTIFACTS: "build: [markdown-toc]"
  only:
    changes:
      - "common/**/*"
      - "markdown-toc/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main
      - tags

publish-update-docker-hub-readme:
  extends: .publish-docker-to-public
  variables:
    DOCKERFILE_CONTEXT: ./update-docker-hub-readme
    DOCKER_IMAGE_NAME: cenk1cenk2/pipe-update-docker-hub-readme
    DOCKER_IMAGE_TAGS: latest
    PARENT_DOWNLOAD_ARTIFACTS: "build: [update-docker-hub-readme]"
  only:
    changes:
      - "common/**/*"
      - "update-docker-hub-readme/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main
      - tags

publish-semantic-release:
  extends: .publish-docker-to-public
  variables:
    DOCKERFILE_CONTEXT: ./semantic-release
    DOCKER_IMAGE_NAME: cenk1cenk2/pipe-semantic-release
    DOCKER_IMAGE_TAGS: latest
    PARENT_DOWNLOAD_ARTIFACTS: "build: [semantic-release]"
  only:
    changes:
      - "common/**/*"
      - "semantic-release/**/*"
      - "node/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main
      - tags

publish-select-env:
  extends: .publish-docker-to-public
  variables:
    DOCKERFILE_CONTEXT: ./select-env
    DOCKER_IMAGE_NAME: cenk1cenk2/pipe-select-env
    DOCKER_IMAGE_TAGS: latest
    PARENT_DOWNLOAD_ARTIFACTS: "build: [select-env]"
  only:
    changes:
      - "common/**/*"
      - "select-env/**/*"
      - go.mod
      - go.sum
      - .gitlab-ci.yml
    refs:
      - main
      - tags
#
# publish-s3-upload:
#   extends: .publish-docker-to-public
#   variables:
#     DOCKERFILE_CONTEXT: ./s3-upload
#     DOCKER_IMAGE_NAME: cenk1cenk2/pipe-s3-upload
#     DOCKER_IMAGE_TAGS: latest
#     PARENT_DOWNLOAD_ARTIFACTS: "build: [s3-upload]"
#   only:
#     changes:
#       - "common/**/*"
#       - "s3-upload/**/*"
#       - go.mod
#       - go.sum
#       - .gitlab-ci.yml
#     refs:
#       - main
#       - tags

docker-hub-readme:
  extends: .docker-hub-readme
  variables:
    DOCKER_USERNAME: $DOCKERHUB_USERNAME
    DOCKER_PASSWORD: $DOCKERHUB_API_PASSWORD
  parallel:
    matrix:
      - DOCKER_IMAGE_NAME: cenk1cenk2/pipe-docker
        README_FILE: ./docker/README.md
        README_DESCRIPTION: |
          Builds and publishes a Docker image with given conditions.

      - DOCKER_IMAGE_NAME: cenk1cenk2/pipe-gl-artifacts
        README_FILE: ./gl-artifacts/README.md
        README_DESCRIPTION: |
          Fetches artifacts from a stage in GitLab pipeline.

      - DOCKER_IMAGE_NAME: cenk1cenk2/pipe-node
        README_FILE: ./node/README.md
        README_DESCRIPTION: |
          Node.JS operations for pipeline.

      - DOCKER_IMAGE_NAME: cenk1cenk2/pipe-gh-release-tracker
        README_FILE: ./gh-release-tracker/README.md
        README_DESCRIPTION: |
          Tracks a GitHub repository and fetches the latest tag.

      - DOCKER_IMAGE_NAME: cenk1cenk2/pipe-markdown-toc
        README_FILE: ./markdown-toc/README.md
        README_DESCRIPTION: |
          Generates TOC for markdown files.

      - DOCKER_IMAGE_NAME: cenk1cenk2/pipe-update-docker-hub-readme
        README_FILE: ./update-docker-hub-readme/README.md
        README_DESCRIPTION: |
          Updates the README on DockerHub for given repository.

      - DOCKER_IMAGE_NAME: cenk1cenk2/pipe-semantic-release
        README_FILE: ./semantic-release/README.md
        README_DESCRIPTION: |
          Semantic-Release embedded inside a container for CI jobs.

      - DOCKER_IMAGE_NAME: cenk1cenk2/pipe-select-env
        README_FILE: ./select-env/README.md
        README_DESCRIPTION: |
          Selects an environment given on the conditions.

      # - DOCKER_IMAGE_NAME: cenk1cenk2/pipe-s3-upload
      #   README_FILE: ./s3-upload/README.md
      #   README_DESCRIPTION: |
      #     Uploads the given artificats to a S3 instance.
