---
stages:
  - bootstrap
  - install
  - pipes
  - post

bootstrap:
  stage: bootstrap
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.bootstrap.yml
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.bootstrap.yml
          - go/
          - buildah/
    - if: $CI_COMMIT_TAG

install:
  stage: install
  image: cenk1cenk2/pipe-go:bootstrap
  script:
    - pipe install
  artifacts:
    paths:
      - vendor/
  cache:
    - key: $CI_JOB_NAME_SLUG
      paths:
        - vendor/
  tags:
    - amd64
    - docker

pipe-template:
  stage: pipes
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          parent-pipeline-id: $CI_PIPELINE_ID
          cwd: ./_template
          container-image-name: cenk1cenk2/pipe-template
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_TAGS: |-
                latest
          container-rules:
            - when: never
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - _template/
    - if: $CI_COMMIT_TAG

pipe-buildah:
  stage: pipes
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          parent-pipeline-id: $CI_PIPELINE_ID
          cwd: ./buildah
          container-image-name: cenk1cenk2/pipe-buildah
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_TAGS: |-
                latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - buildah/
    - if: $CI_COMMIT_TAG

pipe-docker:
  stage: pipes
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          parent-pipeline-id: $CI_PIPELINE_ID
          cwd: ./docker
          container-image-name: cenk1cenk2/pipe-docker
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_TAGS: |-
                latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - docker/
    - if: $CI_COMMIT_TAG

pipe-go:
  stage: pipes
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          parent-pipeline-id: $CI_PIPELINE_ID
          cwd: ./go
          # TODO: update me to the point to go image after migration
          container-image-name: cenk1cenk2/pipe-go
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_BUILD_ARGS: |-
                GO_VERSION: '{{ env "GO_VERSION" }}'
              CONTAINER_IMAGE_TAGS: |-
                {{ env "GO_VERSION" }}
              GO_VERSION:
                - 1.25-alpine
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - go/
    - if: $CI_COMMIT_TAG

pipe-markdown-toc:
  stage: pipes
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          parent-pipeline-id: $CI_PIPELINE_ID
          cwd: ./markdown-toc
          container-image-name: cenk1cenk2/pipe-markdown-toc
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_TAGS: |-
                latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - markdown-toc/
    - if: $CI_COMMIT_TAG

pipe-node:
  stage: pipes
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          parent-pipeline-id: $CI_PIPELINE_ID
          cwd: ./node
          container-image-name: cenk1cenk2/pipe-node
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_BUILD_ARGS: |-
                NODE_VERSION: '{{ env "NODE_VERSION" }}'
              CONTAINER_IMAGE_TAGS: |-
                {{ env "NODE_VERSION" }}
              NODE_VERSION:
                - 20
                - 20-alpine
                - 22
                - 22-alpine
                - 24
                - 24-alpine
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - node/
    - if: $CI_COMMIT_TAG

pipe-select-env:
  stage: pipes
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          parent-pipeline-id: $CI_PIPELINE_ID
          cwd: ./select-env
          container-image-name: cenk1cenk2/pipe-select-env
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_TAGS: |-
                latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - select-env/
    - if: $CI_COMMIT_TAG

pipe-semantic-release:
  stage: pipes
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          parent-pipeline-id: $CI_PIPELINE_ID
          cwd: ./semantic-release
          container-image-name: cenk1cenk2/semantic-release
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_BUILD_ARGS: |-
                NODE_VERSION: 22-alpine
              CONTAINER_IMAGE_TAGS: |-
                latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - semantic-release/
    - if: $CI_COMMIT_TAG

pipe-terraform:
  stage: pipes
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          parent-pipeline-id: $CI_PIPELINE_ID
          cwd: ./terraform
          container-image-name: cenk1cenk2/pipe-terraform
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_TAGS: |-
                latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - terraform/
    - if: $CI_COMMIT_TAG

pipe-update-docker-hub-readme:
  stage: pipes
  trigger:
    strategy: depend
    include:
      - local: .gitlab-ci.pipe.yml
        inputs:
          parent-pipeline-id: $CI_PIPELINE_ID
          cwd: ./update-docker-hub-readme
          container-image-name: cenk1cenk2/pipe-update-docker-hub-readme
          container-matrix:
            - CONTAINER_FILE_NAME: Dockerfile
              CONTAINER_IMAGE_TAGS: |-
                latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - .gitlab-ci.yml
          - go.mod
          - go.sum
          - .gitlab-ci.pipe.yml
          - update-docker-hub-readme/
    - if: $CI_COMMIT_TAG

update-docker-hub-readme:
  stage: post
  image: cenk1cenk2/pipe-update-docker-hub-readme:latest
  dependencies: []
  variables:
    DOCKER_USERNAME: $DOCKERHUB_USERNAME
    DOCKER_PASSWORD: $DOCKERHUB_API_PASSWORD
    README_MATRIX: |
      [
        {
          "repository": "cenk1cenk2/pipe-buildah",
          "file": "./buildah/README.md",
          "description": "Builds and publishes a container image with given conditions."
        },
        {
          "repository": "cenk1cenk2/pipe-docker",
          "file": "./docker/README.md",
          "description": "Builds and publishes a Docker image with given conditions."
        },
        {
          "repository": "cenk1cenk2/pipe-node",
          "file": "./node/README.md",
          "description": "Node.JS operations for pipelines."
        },
        {
          "repository": "cenk1cenk2/pipe-go",
          "file": "./go/README.md",
          "description": "Golang operations for pipelines."
        },
        {
          "repository": "cenk1cenk2/pipe-markdown-toc",
          "file": "./markdown-toc/README.md",
          "description": "Generates TOC for markdown files."
        },
        {
          "repository": "cenk1cenk2/pipe-select-env",
          "file": "./select-env/README.md",
          "description": "Selects an environment given on the conditions."
        },
        {
          "repository": "cenk1cenk2/pipe-semantic-release",
          "file": "./semantic-release/README.md",
          "description": "semantic-release embedded inside a container for CI jobs."
        },
        {
          "repository": "cenk1cenk2/pipe-terraform",
          "file": "./terraform/README.md",
          "description": "Terraform helper pipe."
        },
        {
          "repository": "cenk1cenk2/pipe-update-docker-hub-readme",
          "file": "./update-docker-hub-readme/README.md",
          "description": "Updates the README on DockerHub for given repository."
        }
      ]
  script:
    - pipe
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - "**/README.md"
    - if: $CI_COMMIT_TAG
