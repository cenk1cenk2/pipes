init:
  needs: []
  image: golang:1.25-alpine
  variables:
    GO_BUILD_BINARY_NAME: pipe
  parallel:
    matrix:
      - GO_CWD:
          - go
          - buildah
  script:
    - go mod vendor
    - go mod verify
    - |-
      (
        cd go
        go build -mod=vendor -o dist/pipe-bootstrap
      )
    - ./go/dist/pipe-bootstrap --version
    - ./go/dist/pipe-bootstrap tool -- golangci-lint run --timeout 3m
    - ./go/dist/pipe-bootstrap build
  artifacts:
    paths:
      - ${GO_CWD}/dist/
  tags:
    - amd64
    - docker

container:
  needs:
    - job: init
      parallel:
        matrix:
          - GO_CWD: "${GO_CWD}"
  stage: container
  image: quay.io/buildah/stable:latest
  variables:
    CONTAINER_IMAGE_TAGS: bootstrap
  script:
    - ./buildah/dist/pipe-linux-amd64 build
  parallel:
    matrix:
      - GO_CWD: go
        CONTAINER_FILE_CONTEXT: ./go
        CONTAINER_IMAGE_NAME: docker.io/cenk1cenk2/pipe-go2
        CONTAINER_IMAGE_BUILD_ARGS: |-
          GO_VERSION: 1.25-alpine
      - GO_CWD: buildah
        CONTAINER_FILE_CONTEXT: ./buildah
        CONTAINER_IMAGE_NAME: docker.io/cenk1cenk2/pipe-buildah
        CONTAINER_IMAGE_BUILD_ARGS: |-
          BUILDAH_VERSION: latest
  tags:
    - amd64
    - docker
