---
stages:
  - init
  - container

init:
  stage: init
  image: golang:1.25-alpine
  variables:
    GO_BUILD_BINARY_NAME: pipe
    GO_BUILD_LINKER: -w -s
    GO_BUILD_VARIABLES: |-
      main.VERSION: bootstrap.{{ now | date "2006-01-02T15:04:05Z0700" }}
  parallel:
    matrix:
      - GO_CWD: go
      - GO_CWD: buildah
  script:
    - wget -O- -nv https://raw.githubusercontent.com/golangci/golangci-lint/HEAD/install.sh | BINDIR=/usr/bin sh -s
    - go mod vendor
    - go mod verify
    - |-
      (
        cd go
        go build -mod=vendor -o dist/pipe-bootstrap
      )
    - ./go/dist/pipe-bootstrap --version
    - ./go/dist/pipe-bootstrap lint
    - ./go/dist/pipe-bootstrap build
  cache:
    - key: bootstrap-init
      paths:
        - vendor/
        - $GO_CWD/dist/
  artifacts:
    paths:
      - $GO_CWD/dist/
  tags:
    - amd64
    - docker

container:
  stage: container
  image: quay.io/buildah/stable:latest
  variables:
    CONTAINER_IMAGE_TAGS: bootstrap
    CONTAINER_REGISTRY_USERNAME: $DOCKERHUB_USERNAME
    CONTAINER_REGISTRY_PASSWORD: $DOCKERHUB_PASSWORD
  script:
    - ./buildah/dist/pipe-linux-amd64 build
  parallel:
    matrix:
      - CONTAINER_FILE_CONTEXT: ./go
        CONTAINER_IMAGE_NAME: cenk1cenk2/pipe-go
        CONTAINER_IMAGE_BUILD_ARGS: |-
          GO_VERSION: 1.25-alpine
      - CONTAINER_FILE_CONTEXT: ./buildah
        CONTAINER_IMAGE_NAME: cenk1cenk2/pipe-buildah
        CONTAINER_IMAGE_BUILD_ARGS: |-
          BUILDAH_VERSION: latest
  tags:
    - amd64
    - docker
